---
title: "Extrapolation of Tassajara rain gauge"
output:
  github_document: default
  html_notebook: default
keep_md: true
---

```{r}
library(tidyverse)
ggplot2::theme_set(theme_classic())

```

```{r}

if (!file.exists("data/rawdata_tas.rds")){
  rawdata_tas <- read_csv("https://cdec.water.ca.gov/dynamicapp/req/CSVDataServlet?Stations=TAS&SensorNums=16&dur_code=E&Start=1900-01-01&End=2023-02-16")
  rawdata_tas %>% saveRDS(file = "data/rawdata_tas.rds")
}
if (!file.exists("data/rawdata_mlr.rds")){
rawdata_mlr <- read_csv("https://cdec.water.ca.gov/dynamicapp/req/CSVDataServlet?Stations=MLR&SensorNums=2&dur_code=H&Start=1900-01-01&End=2023-02-16")
rawdata_mlr %>% saveRDS(file = "data/rawdata_mlr.rds")
}
```


```{r}
rawdata_tas <- readRDS(file = "data/rawdata_tas.rds")
rawdata_mlr <- readRDS(file = "data/rawdata_mlr.rds")

daily_data_tas <- rawdata_tas %>%
  as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(date = lubridate::round_date(date_time, unit="day"),
         increment = case_when(value >= lag(value, n=1) ~ value - lag(value, n=1))) %>%
  group_by(date) %>%
  summarize(precip_tas = sum(increment))

daily_data_tas %>% ggplot(aes(y = precip_tas, x = date)) + geom_col()

daily_data_mlr <- rawdata_mlr %>% 
  as_tibble() %>%
  janitor::clean_names() %>% 
  mutate(date = lubridate::round_date(date_time, unit="day"),
         value = as.numeric(value),
         increment = case_when(value >= lag(value, n=1) ~ value - lag(value, n=1))) %>%
  group_by(date) %>%
  summarize(precip_mlr = sum(increment))

daily_data_mlr %>% ggplot(aes(y = precip_mlr, x = date)) + geom_col()


```

```{r}

daily_data <- daily_data_mlr %>% 
  left_join(daily_data_tas) 

daily_data_filtered <- daily_data %>%
  filter(precip_tas > 0 & precip_mlr > 0)

daily_data_filtered %>% 
  #select(c(precip_tas, precip_mlr)) %>%
  #filter((precip_tas > 0) & (precip_mlr > 0)) %>%
  #drop_na() %>%
  ggplot(aes(y = precip_tas, x = precip_mlr)) +
    geom_point() +
    scale_y_log10() +
    scale_x_log10() + 
    geom_smooth(method="lm")

model <- lm(log(daily_data_filtered$precip_tas) ~ log(daily_data_filtered$precip_mlr))
summary(model)
alpha <- exp(model$coefficients["(Intercept)"])
beta <- model$coefficients["log(daily_data_filtered$precip_mlr)"]

daily_data_pred <- daily_data %>% 
  mutate(precip_tas_pred = case_when(
    !is.na(precip_mlr) ~ alpha * precip_mlr^beta, 
    TRUE ~ 0
    ))

daily_data_pred %>% ggplot(aes(y = precip_tas_pred, x = date)) + geom_col()
ggsave("barchart.svg")

daily_data_pred %>% write_csv("data/daily_data_pred.csv")

```
```{r}
ndvi_time_series <- read_csv("data/ndvi_time_series.csv")

ndvi_time_series_interp <- ndvi_time_series %>%
  mutate(date_round = as.Date(lubridate::round_date(time, unit = "day"))) %>%
  complete(date_round = seq.Date(from = min(date_round), to = max(date_round), by = "day")) %>%
  mutate(ndvi = zoo::na.approx(ndvi)) %>%
  mutate(rolling_ndvi = zoo::rollapply(ndvi, 365, mean, align='center', fill=NA))

```

```{r}

maxRange <- 3/2
coeff <- 2/3

ggplot() + 
geom_area(data = daily_data_pred, aes(y = precip_tas_pred, x = date), color="cadetblue") +
geom_line(data = ndvi_time_series_interp, aes(y = ndvi/coeff, x = time), color="darkolivegreen2") +
geom_line(data = ndvi_time_series_interp, aes(y = rolling_ndvi/coeff, x = time), color="seagreen") +
scale_y_continuous(name = "precipitation",
                 limit = c(0, maxRange),
                 expand = c(0, 0),
                 sec.axis = sec_axis(trans = ~.*coeff, 
                                     name = "NDVI"))

```
